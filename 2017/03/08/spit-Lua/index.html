<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>Lua的一些坑的记录 | 专业闭关三十年</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Lua是一门很小巧的编程语言，不过使用过程中发下一些容易出现问题的地方，这里记录一下（API正常使用不记录）。记录时使用的版本是官方Lua 5.3.4版本源码.  Lua的table区分数组部分和哈希表部分，数组部分索引从1开始，而不是0-based  Lua的C API中的lua_isstring和lua_isnumber有点坑   1234567891011121314151617181920">
<meta name="keywords" content="Lua">
<meta property="og:type" content="article">
<meta property="og:title" content="Lua的一些坑的记录">
<meta property="og:url" content="http://zoowii.com/2017/03/08/spit-Lua/index.html">
<meta property="og:site_name" content="专业闭关三十年">
<meta property="og:description" content="Lua是一门很小巧的编程语言，不过使用过程中发下一些容易出现问题的地方，这里记录一下（API正常使用不记录）。记录时使用的版本是官方Lua 5.3.4版本源码.  Lua的table区分数组部分和哈希表部分，数组部分索引从1开始，而不是0-based  Lua的C API中的lua_isstring和lua_isnumber有点坑   1234567891011121314151617181920">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2020-02-25T12:41:04.885Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Lua的一些坑的记录">
<meta name="twitter:description" content="Lua是一门很小巧的编程语言，不过使用过程中发下一些容易出现问题的地方，这里记录一下（API正常使用不记录）。记录时使用的版本是官方Lua 5.3.4版本源码.  Lua的table区分数组部分和哈希表部分，数组部分索引从1开始，而不是0-based  Lua的C API中的lua_isstring和lua_isnumber有点坑   1234567891011121314151617181920">
  
    <link rel="alternative" href="/atom.xml" title="专业闭关三十年" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  

</head></html>
<body>
  <div id="container">
    <div id="wrap">
      <div class="outer">
        <section id="main"><article id="post-spit-Lua" class="article article-type-post" itemscope itemprop="blogPost">
  
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Lua的一些坑的记录
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2017/03/08/spit-Lua/" class="article-date">
  <time datetime="2017-03-08T02:02:32.000Z" itemprop="datePublished">2017-03-08</time>
</a>
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>Lua是一门很小巧的编程语言，不过使用过程中发下一些容易出现问题的地方，这里记录一下（API正常使用不记录）。记录时使用的版本是官方Lua 5.3.4版本源码.</p>
<ul>
<li><p>Lua的table区分数组部分和哈希表部分，数组部分索引从1开始，而不是0-based</p>
</li>
<li><p>Lua的C API中的lua_isstring和lua_isnumber有点坑</p>
</li>
</ul>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">LUA_API int lua_isnumber (<span class="name">lua_State</span> *L, int idx) &#123;</span><br><span class="line">    lua_Number n;</span><br><span class="line">    const TValue *o = index2addr(<span class="name">L</span>, idx)<span class="comment">;</span></span><br><span class="line">    return tonumber(<span class="name">o</span>, <span class="symbol">&amp;n</span>)<span class="comment">;   // 坑，会执行转换成number类型改动栈</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">LUA_API int lua_isstring (<span class="name">lua_State</span> *L, int idx) &#123;</span><br><span class="line">    const TValue *o = index2addr(<span class="name">L</span>, idx)<span class="comment">;</span></span><br><span class="line">    // 坑，这里逻辑是看能否转换成string，之后如果调用lua_tostring会改动栈中值，在遍历table判断key的时候就悲催了</span><br><span class="line">    return (<span class="name">ttisstring</span>(<span class="name">o</span>) || cvt2str(<span class="name">o</span>))<span class="comment">;  </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-- 容易导致错误的使用比如</span><br><span class="line">lua_State *L = luaL_newstate();</span><br><span class="line">luaL_dostring(L, "a=&#123;&#125;;a[2]=123");</span><br><span class="line">lua_getglobal(L, "a");</span><br><span class="line"></span><br><span class="line">lua_pushnil(L);</span><br><span class="line">while(lua_next(L, -2))</span><br><span class="line">&#123;</span><br><span class="line">    auto is_string_key = lua_isstring(L, -2);</span><br><span class="line">    if (lua_isstring(L, -2))</span><br><span class="line">    &#123;</span><br><span class="line">        printf("%s=", luaL_checkstring(L, -2));</span><br><span class="line">    &#125;</span><br><span class="line">    else if(lua_isinteger(L, -2))</span><br><span class="line">    &#123;</span><br><span class="line">        printf("%d=", luaL_checkinteger(L, -2));</span><br><span class="line">    &#125;</span><br><span class="line">    printf("%d\n", luaL_checkinteger(L, -1));</span><br><span class="line">    lua_pop(L, 1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">lua_close(L);</span><br><span class="line"></span><br><span class="line">-- 以上这段代码会进程崩溃,因为错误的对int值进行了luaL_checkstring(或lua_tostring)导致当前lua虚拟堆栈被改写，然后lua_next的时候会找不到正确的key，然后报错崩溃</span><br><span class="line">-- 而下面这样写就正常了</span><br><span class="line">lua_State *L = luaL_newstate()<span class="comment">;</span></span><br><span class="line">    </span><br><span class="line">luaL_dostring(<span class="name">L</span>, <span class="string">"a=&#123;&#125;;a[2]=123"</span>)<span class="comment">;</span></span><br><span class="line">lua_getglobal(<span class="name">L</span>, <span class="string">"a"</span>)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">lua_pushnil(<span class="name">L</span>)<span class="comment">;</span></span><br><span class="line">while(<span class="name">lua_next</span>(<span class="name">L</span>, <span class="number">-2</span>))</span><br><span class="line">&#123;</span><br><span class="line">    auto is_string_key = lua_isstring(<span class="name">L</span>, <span class="number">-2</span>)<span class="comment">;</span></span><br><span class="line">    if(<span class="name">lua_isinteger</span>(<span class="name">L</span>, <span class="number">-2</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        printf(<span class="string">"%d="</span>, luaL_checkinteger(<span class="name">L</span>, <span class="number">-2</span>))<span class="comment">;</span></span><br><span class="line">    &#125; </span><br><span class="line">    else if (<span class="name">lua_isstring</span>(<span class="name">L</span>, <span class="number">-2</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        printf(<span class="string">"%s="</span>, luaL_checkstring(<span class="name">L</span>, <span class="number">-2</span>))<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">    printf(<span class="string">"%d\n"</span>, luaL_checkinteger(<span class="name">L</span>, <span class="number">-1</span>))<span class="comment">;</span></span><br><span class="line">    lua_pop(<span class="name">L</span>, <span class="number">1</span>)<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">lua_close(<span class="name">L</span>)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">-- lua_isnumber也有类似问题，实现中是调用lua_tonumber看能否转换成number类型来判断，而这会改动lua虚拟堆栈结构，在遍历lua table的时候有问题</span><br></pre></td></tr></table></figure>
<ul>
<li><p>Lua的C API中的lua_type函数，得到的类型可以用来判断布尔，nil，字符串类型,比如lua_type(L, -1) == LUA_TSTRING,但是不能用来直接判断整数，不能lua_type(L, -1) == LUA_TNUMINT  因为Lua 5.3中虽然区分了int和number类型，把整数和浮点数区分出来了，但是lua_type的返回类型都是LUA_TNUMBER，LUA_TNUMINT和LUA_TNUMFLT都是LUA_TNUMBER进行偏移后的结果。需要判断类型的时候整数需要使用lua_isinteger(L,-1)，浮点数需要使用lua_type(L, -1) == LUA_TNUMBER</p>
</li>
<li><p>Lua的一些函数比如#，ipairs, table中一些函数，都是只对Lua table中的数组部分起效果，建议不要对同一个lua table同时使用数组部分和哈希表部分，可能容易出错。我们的做法是对Lua语言做了修改，增加了可选的类型声明和编译期静态类型系统并区分了Array<t>和Map<t>类型，减少混用导致的问题。</t></t></p>
</li>
<li><p>Lua中的数学操作符，必须参数都是数字，注意使用时候不要错误使用了类型，包括nil也不行，比如+/-/*//还有其他一些数学操作符</p>
</li>
<li><p>注意区分lua_pcall/lua_pcallk和lua_call/lua_callk的使用区分，前者是runproteced模式下运行，也就是会捕获运行时异常并处理，不对使用者再直接抛出异常崩溃.但是也不要乱用lua_pcall，只在最外层使用</p>
</li>
<li><p>暂时就想到这些，以前可能也碰到一些其他问题没记录下来，以后我想起或者又碰到了再补充</p>
</li>
</ul>

      

      
        
    </div>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/04/13/dotnet-to-lua-bytecode/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          .Net字节码转换到Lua字节码的实现方式
        
      </div>
    </a>
  
  
    <a href="/2015/04/06/一个简单的正则表达式和语法分析引擎的JavaScript实现parser-js/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">一个简单的正则表达式和语法分析引擎的JavaScript实现parser.js</div>
    </a>
  
</nav>

  
</article>

</section>
        <aside id="sidebar">
  <nav class="menus">
  	<ul>
  		<li><a href="/"><i class="icon icon-home"></i></a></li>
  		
			<li><a href="/archives"><i class="icon icon-fenlei"></i></a></li>
  		
  		
			<li><a href="/tags"><i class="icon icon-tag"></i></a></li>
  		
  		
  			<li><a href="https://github.com/" target="_blank"><i class="icon icon-github"></i></a></li>
  		
  	</ul>
  </nav>
  <a id="go-top" href="#"><i class="icon icon-up"></i></a>
</aside>
      </div>
      <footer id="footer">
  
	<div id="footer-info" class="inner">
	  &copy; 2020 zoowii 
	  - Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
	  - Theme <a href="https://github.com/Alex-fun/hexo-theme-jane/" target="_blank">Jane</a>
	</div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/tags" class="mobile-nav-link">Tag</a>
  
    <a href="https://github.com/" class="mobile-nav-link">Github</a>
  
</nav>
    

<script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>