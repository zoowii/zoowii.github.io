<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>Scheme的continuation的实现方式(SchemePy) | 专业闭关三十年</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="在Lisp的一些方言中有一种特别的东西，叫做continuation，尤其是在Scheme语言中。 不过其实continuation也不是lisp特有的东西，其他语言中也有本质上相同或类似的东西，也许不叫一样的名字。只不过scheme中直接把continuation的控制权限交给coder自己，能够由程序员自己控制它。 然后，本文说的是怎么实现continuation的，首先要给出continua">
<meta name="keywords" content="Scheme">
<meta property="og:type" content="article">
<meta property="og:title" content="Scheme的continuation的实现方式(SchemePy)">
<meta property="og:url" content="http://zoowii.com/2014/01/23/Scheme的continuation的实现方式-SchemePy/index.html">
<meta property="og:site_name" content="专业闭关三十年">
<meta property="og:description" content="在Lisp的一些方言中有一种特别的东西，叫做continuation，尤其是在Scheme语言中。 不过其实continuation也不是lisp特有的东西，其他语言中也有本质上相同或类似的东西，也许不叫一样的名字。只不过scheme中直接把continuation的控制权限交给coder自己，能够由程序员自己控制它。 然后，本文说的是怎么实现continuation的，首先要给出continua">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2020-02-25T12:41:04.878Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Scheme的continuation的实现方式(SchemePy)">
<meta name="twitter:description" content="在Lisp的一些方言中有一种特别的东西，叫做continuation，尤其是在Scheme语言中。 不过其实continuation也不是lisp特有的东西，其他语言中也有本质上相同或类似的东西，也许不叫一样的名字。只不过scheme中直接把continuation的控制权限交给coder自己，能够由程序员自己控制它。 然后，本文说的是怎么实现continuation的，首先要给出continua">
  
    <link rel="alternative" href="/atom.xml" title="专业闭关三十年" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  

</head></html>
<body>
  <div id="container">
    <div id="wrap">
      <div class="outer">
        <section id="main"><article id="post-Scheme的continuation的实现方式-SchemePy" class="article article-type-post" itemscope itemprop="blogPost">
  
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Scheme的continuation的实现方式(SchemePy)
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2014/01/23/Scheme的continuation的实现方式-SchemePy/" class="article-date">
  <time datetime="2014-01-22T16:00:00.000Z" itemprop="datePublished">2014-01-23</time>
</a>
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>在Lisp的一些方言中有一种特别的东西，叫做continuation，尤其是在Scheme语言中。</p>
<p>不过其实continuation也不是lisp特有的东西，其他语言中也有本质上相同或类似的东西，也许不叫一样的名字。只不过scheme中直接把continuation的控制权限交给coder自己，能够由程序员自己控制它。</p>
<p>然后，本文说的是怎么实现continuation的，首先要给出continuation的定义。</p>
<p>以状态机的模型定义计算机的话，可以把一个计算机看做是下面这个函数<br>f(S) = S, 其中S是计算机状态的集合，f就是计算机的程序逻辑</p>
<p>再具体一点，具体到scheme的执行中去，状态集合S就是scheme的上下文环境（env），接下来要执行的程序（continuation），词法作用域（非必须，以下不考虑）</p>
<p>上下文env就是一个记录名称key=&gt;值的记录，这个值可以是基本数值，也可以是一块内存的指针（地址），不过这不影响本文主题，以下直接把所有env中的值看做是对象的应用，不考虑内存的影响增加复杂度。同时env要有一个记录上一层级的指针，指向另一个env。所以上下文env的结构大致如下（一个list结构，列表的一个节点是一个map对象）：</p>
<pre><code>                                       -&gt; parent = null
                                       -&gt;key3 =&gt; value3
                                       -&gt;key2 =&gt; value2
- parent(default = null) -----------------------------&gt;- -key1 =&gt; value1
-  key1=&gt; value1
- key2 =&gt; value2
--&lt;-----------------------------------------另一个env
</code></pre><ul>
<li>continuation就是保存下接下来要执行的代码</li>
<li>f 就是一个循环，不断接受env和continuation，执行固定的逻辑，返回结果重新再次执行</li>
</ul>
<p>然后上面的f(S) = S就相当于<br><code>f(env, continuation) = (env2, continuation2)</code></p>
<p>这个式子应用到图灵计算机中就是：</p>
<ul>
<li>env就是内存中的数据区</li>
<li>continuation就是内存中的指令序列，和PC计数器</li>
<li>f就是图灵计算机中从指令序列中按PC计数器读取下一条指令，在CPU中执行，对内存数据进行操作（得到env2），然后PC计数器+1(得到continuation2)</li>
</ul>
<p>简便起见，用一段简单的scheme代码描述上面过程</p>
<p>给一个continuation的大概结构先：</p>
<pre><code>{
    code_list: ..., 一个scheme的列表，运行时可能会动态修改
    current: code_list中的当前位置的ID（当前位置可以是code_list中某个元素，或者一个list中的某些位置）
}
</code></pre><p>看代码：</p>
<pre><code>(define a 100)
(define (fib n)
  (if (&lt; n 3)
  1
  (+ (fib (- n 1)
     (fib (- n 2)))))
(display (fib a))
</code></pre><p>解释执行时，最开始的状态是<code>env= {}, continuation={code_list: ..., current: null}</code></p>
<p>然后开始运行后，比如运行到(define a 100)时，执行之前continuation的current指向这个列表，执行则修改env，并且将current指向下一个位置，结束一次执行。</p>
<p>至于scheme中的call/cc，因为continuation也是一个scheme对象，调用call/cc时把这个对象作为参数传递给调用call/cc时的参数（一个函数g），在g的执行过程中，如果调用了这个continuation(命名cont），则把这个cont替换掉当前的continuation并继续执行</p>
<p>先睡了，下次有空再说详细点</p>
<p>PS:</p>
<ol>
<li>关于这个基于f(env, cont)=(env2, cont2)的计算模型用java实现的demo见<a href="https://github.com/zoowii/lisp-continuation" target="_blank" rel="noopener">https://github.com/zoowii/lisp-continuation</a>。注意，这个demo无法运行，因为没有完成，只是给出代码结构和主要代码，对一些细节没有完善。</li>
</ol>

      

      
        
    </div>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2014/01/24/基于f-env-cont-to-env2-cont2的scheme解释器的实现原理/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          基于f(env,cont)=(env2,cont2)的scheme解释器的实现原理
        
      </div>
    </a>
  
  
    <a href="/2014/01/17/关于将Django网站迁移到SAE上的问题/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">关于将Django网站迁移到SAE上的问题</div>
    </a>
  
</nav>

  
</article>

</section>
        <aside id="sidebar">
  <nav class="menus">
  	<ul>
  		<li><a href="/"><i class="icon icon-home"></i></a></li>
  		
			<li><a href="/archives"><i class="icon icon-fenlei"></i></a></li>
  		
  		
			<li><a href="/tags"><i class="icon icon-tag"></i></a></li>
  		
  		
  			<li><a href="https://github.com/" target="_blank"><i class="icon icon-github"></i></a></li>
  		
  	</ul>
  </nav>
  <a id="go-top" href="#"><i class="icon icon-up"></i></a>
</aside>
      </div>
      <footer id="footer">
  
	<div id="footer-info" class="inner">
	  &copy; 2020 zoowii 
	  - Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
	  - Theme <a href="https://github.com/Alex-fun/hexo-theme-jane/" target="_blank">Jane</a>
	</div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/tags" class="mobile-nav-link">Tag</a>
  
    <a href="https://github.com/" class="mobile-nav-link">Github</a>
  
</nav>
    

<script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>